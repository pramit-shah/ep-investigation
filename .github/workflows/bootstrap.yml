name: Bootstrap Investigation System

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Configure Git
        run: |
          git config --global user.name "Bootstrap Bot"
          git config --global user.email "bootstrap-bot@users.noreply.github.com"
      
      - name: Check if workflows exist
        id: check
        run: |
          if [ -f ".github/workflows/continuous-investigation.yml" ] && [ -f ".github/workflows/self-healing.yml" ]; then
            echo "workflows_exist=true" >> $GITHUB_OUTPUT
            echo "âœ“ Workflows already deployed"
          else
            echo "workflows_exist=false" >> $GITHUB_OUTPUT
            echo "âš  Workflows need to be generated"
          fi
      
      - name: Generate workflows
        if: steps.check.outputs.workflows_exist == 'false'
        run: |
          echo "Generating workflows..."
          python3 deploy_workflows.py
      
      - name: Commit workflows
        if: steps.check.outputs.workflows_exist == 'false'
        run: |
          git add .github/workflows/continuous-investigation.yml .github/workflows/self-healing.yml
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ¤– Auto-deploy investigation workflows

            Workflows generated by bootstrap system:
            - continuous-investigation.yml (runs every 6 hours)
            - self-healing.yml (runs every 2 hours)
            
            System is now live and will run autonomously."
            
            git push origin main
            echo "âœ“ Workflows deployed successfully"
          else
            echo "âœ“ No changes to commit"
          fi
      
      - name: Initialize investigation
        run: |
          echo "Initializing investigation system..."
          python3 setup.py
      
      - name: Run first cycle
        continue-on-error: true
        run: |
          echo "Running initial investigation cycle..."
          python3 run_autonomous_cycle.py \
            --research-duration 5 \
            --orchestration-duration 5 \
            --tasks-duration 5
      
      - name: Bootstrap complete
        run: |
          echo "============================================================"
          echo "Bootstrap Complete!"
          echo "============================================================"
          echo ""
          echo "âœ“ Workflows deployed"
          echo "âœ“ Investigation system initialized"
          echo "âœ“ First cycle completed"
          echo ""
          echo "The system is now running autonomously:"
          echo "  - Continuous Investigation: Every 6 hours"
          echo "  - Self-Healing: Every 2 hours"
          echo ""
          echo "Check the Actions tab to monitor progress."
